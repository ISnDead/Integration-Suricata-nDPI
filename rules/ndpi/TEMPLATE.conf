# ================================================================
# nDPI RULE TEMPLATE
# ---------------------------------------------------------------
# Purpose:
#   Detect network activity based on:
#     - protocol identified by nDPI (ndpi-protocol)
#     - risk level assigned by nDPI (ndpi-risk)
#
# Important notes:
#   - Rules must use only fields supported by the nDPI plugin in Suricata.
#   - Avoid content/file_data unless absolutely necessary — nDPI operates at flow/metadata level.
#   - SID must be unique and not match 2000000-3000000 (filled under the standard suricata rules).
#   - Metadata is mandatory.
# ================================================================

# Example rule: detect high-risk traffic by protocol
alert tcp any any -> any any (
    msg:"[nDPI] <THREAT DESCRIPTION IN ENGLISH>"; \
    # Conditions required to activate rule via nDPI
    requires:keyword ndpi-protocol, keyword ndpi-risk; \
    # Specify exact nDPI protocol name (e.g., HTTP, TOR, STEAM, etc.)
    ndpi-protocol:<NDPI_PROTOCOL_NAME>; \
    # Specify risk label (e.g., NDPI_BINARY_APPLICATION_TRANSFER, NDPI_RISK_POTENTIALLY_UNWANTED)
    ndpi-risk:<NDPI_RISK_LABEL>; \
    # Unique rule ID (must be >= 3000000)
    sid:3000001; \
    # Rule revision (increment when logic changes)
    rev:1; \
    # Classification type (use existing or add to classification.config)
    classtype:attempted-recon; \
    # Metadata — REQUIRED for all rules
    metadata: \
        attack_target Client_Endpoint, \
        created_at YYYY_MM_DD, \
        deployment Perimeter, \
        updated_at YYYY_MM_DD, \
        mitre_tactic_id TAxxxx, \
        mitre_tactic_name <Tactic Name>, \
        mitre_technique_id Txxxx, \
        mitre_technique_name <Technique Name>;
)

# ================================================================
# ADDITIONAL GUIDELINES:
# 
# 1. To list available protocols and risk labels:
#      ndpiReader -H
#    or consult official nDPI documentation.
#
# 2. Do NOT use flowbits, file.data, content, etc. — they are unnecessary
#    if you rely solely on nDPI classification.
#
# 3. If you need to combine nDPI + payload inspection, create a separate rule
#    in rules/manual/, NOT in rules/ndpi/.
#
# 4. After writing a rule:
#    - Add a .pcap sample to test/pcaps/
#    - Fill FP/NP results in rules/ndpi/tests/matrix_coverage.xlsx
#    - Run validation: ./scripts/rules_validation_script.sh
# ================================================================



# ================================================================
# ШАБЛОН ПРАВИЛА ДЛЯ ИНТЕГРАЦИИ С nDPI
# ---------------------------------------------------------------
# Назначение:
#   Обнаружение сетевой активности на основе:
#     - протокола, распознанного nDPI (ndpi-protocol)
#     - уровня риска, определённого nDPI (ndpi-risk)
#
# Важно:
#   - Все правила должны использовать только поля, поддерживаемые плагином nDPI в Suricata.
#   - Не используйте content/file_data без крайней необходимости — nDPI работает на уровне потока и метаданных.
#   - sid должен быть уникальным и не совпадать с 2000000-3000000 (забиты под стандартные правила suricata).
#   - Обязательно указывайте metadata.
# ================================================================

# Пример правила: обнаружение высокорискового трафика по протоколу
alert tcp any any -> any any (
    msg:"[nDPI] <ОПИСАНИЕ УГРОЗЫ НА АНГЛИЙСКОМ>"; \
    # Условия, требуемые для активации правила через nDPI
    requires:keyword ndpi-protocol, keyword ndpi-risk; \
    # Укажите точное имя протокола из списка nDPI (например: HTTP, TOR, STEAM и т.д.)
    ndpi-protocol:<NDPI_PROTOCOL_NAME>; \
    # Укажите уровень риска (например: NDPI_BINARY_APPLICATION_TRANSFER, NDPI_RISK_POTENTIALLY_UNWANTED и т.д.)
    ndpi-risk:<NDPI_RISK_LABEL>; \
    # Уникальный идентификатор правила (обязательно >= 3000000)
    sid:3000001; \
    # Версия правила (увеличивается при изменении логики)
    rev:1; \
    # Классификация (рекомендуется использовать существующие или добавить в classification.config)
    classtype:attempted-recon; \
    # Метаданные — ОБЯЗАТЕЛЬНЫ для всех правил
    metadata: \
        attack_target Client_Endpoint, \
        created_at YYYY_MM_DD, \
        deployment Perimeter, \
        updated_at YYYY_MM_DD, \
        mitre_tactic_id TAxxxx, \
        mitre_tactic_name <Tactic Name>, \
        mitre_technique_id Txxxx, \
        mitre_technique_name <Technique Name>;
)

# ================================================================
# ДОПОЛНИТЕЛЬНЫЕ РЕКОМЕНДАЦИИ:
# 
# 1. Для проверки доступных протоколов и risk-лейблов:
#      ndpiReader -H
#    или см. официальную документацию nDPI.
#
# 2. Не используйте flowbits, file.data, content и т.п. — они не нужны,
#    если вы полагаетесь только на nDPI-классификацию.
#
# 3. При необходимости комбинировать nDPI + анализ payload — создайте отдельное правило
#    в rules/manual/, а не в rules/ndpi/.
#
# 4. После написания правила:
#    - добавьте .pcap в test/pcaps/
#    - заполните результаты FP/NP в rules/ndpi/tests/matrix_coverage.xlsx
#    - запустите валидацию: ./scripts/rules_validation_script.sh
# ================================================================
